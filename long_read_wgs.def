# long_read_wgs_pipeline.def
Bootstrap: docker
From: condaforge/mambaforge:latest

%labels
    Author jia.zhang@qimrb.edu.au
    Version 1.0
    Description Tools used in variant detection pipeline using long read sequencing

%files
    /working/lab_nicw/jiaZ/local/nanomonsv_scripts /opt/nanomonsv_scripts

%post
    # Update base conda environment
    mamba update -n base -c defaults conda -y
    
    # Install tools from bioconda
    mamba install -n base -c conda-forge -c bioconda \
        python=3.10 \
        pip \
        make \
        gcc_linux-64 \
        gxx_linux-64 \
        xz \
        libcurl \
        curl \
        samtools=1.22.1 \
        minimap2=2.30 \
        pybedtools=0.12.0 \
        mosdepth=0.3.11 \
        chopper=0.10.0 \
        r-tidyverse=2.0.0 \
        r-ggrepel=0.9.6 \
        pysam=0.23.3 \
        mafft=7.526 \
        bwa=0.7.19 \
        repeatmasker=4.1.9 \
        bedtools=2.31.1 \
        racon=1.5.0 \
        delly=1.3.3 \
        bcftools=1.22 \
        whatshap=2.8 \
        savana=1.3.5 \
        severus=1.5 \
        sniffles=2.6.2 \
        ont-modkit=0.5.0 \
        -y
    
    # Install Python-based SV callers via pip
    pip install \
        nanomonsv==0.8.0 pod5==0.3.28
    
    # Clean up
    mamba clean --all --force-pkgs-dirs -y
    
    # Create directories for binding
    mkdir -p /data /scratch /work

%environment
    export PATH=/opt/conda/bin:/opt/bin/:$PATH
    export LC_ALL=C.UTF-8
    export LANG=C.UTF-8

%runscript
    echo "Long read DNA sequencing analysis container"
    echo "Available tools:"
    echo "  - minimap2 $(minimap2 --version)"
    echo "  - mosdepth $(mosdepth --version)"
    echo "  - chopper $(chopper --version)"
    echo "  - R $(R --version | head -n 1)
    echo "  - samtools $(samtools --version | head -1)"
    echo "  - delly $(delly --version 2>&1 | head -1)"
    echo "  - nanomonsv $(nanomonsv --version)"
    echo "  - savana $(python -c 'import savana; print(savana.__version__)' 2>/dev/null || echo 'version check failed')"
    echo "  - sniffles $(sniffles --version)"
    echo "  - modkit $(modkit --version)"

%test
    samtools --version
    mosdepth --version
    R --version
    minimap2 --version
    delly --version || true
    nanomonsv --version
    sniffles --version
    modkit --version
    bcftools --version
    chopper --version
    severus --version || true
